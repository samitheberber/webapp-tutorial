<!DOCTYPE html>
<html>
    <head>
        <title>Web Application Tutorial</title>
    </head>
    <body>
        <h1>Web Application Tutorial</h1>

        <p>This tutorial shows how to create web application with sinatra. The tutorial expects that Git is in use.</p>


        <h2>Table of Content</h2>

        <ol>
            <li><a href="#ruby_rvm_bundler">Ruby, RVM and bundler</a></li>
            <li><a href="#creating_new_sinatra_project">Creating new project with sinatra</a></li>
            <li><a href="#short_ruby_tutorial">Short ruby tutorial</a></li>
            <li><a href="#handling_responses">Handling responses</a></li>
            <li><a href="#creating_erbviews">Creating erb-views</a></li>
            <li><a href="#using_classes">Using classes</a></li>
            <li><a href="#adding_database">Adding database</a></li>
            <li><a href="#sessions">Sessions</a></li>
            <li><a href="#heroku_deployment">Heroku deployment</a></li>
            <li><a href="#read_more">Read more</a></li>
        </ol>


        <h2 id="ruby_rvm_bundler">Ruby, RVM and bundler</h2>

        <p>In my course we are using Ruby 1.8.7, RVM and bundler. I try to tell the role of each tools in this chapter.</p>

        <h3>Installing ruby for Windows</h3>

        <p>Tools for Windows aren't so great as they are in Unix world, but you can manage with them. All you need is <a href="http://rubyinstaller.org/">RubyInstaller</a>. If you want use many versions of ruby, you can try <a href="https://github.com/vertiginous/pik">pik</a>.

        <h3>Installing ruby for Unix (the RVM way)</h3>

        <p><a href="https://rvm.beginrescueend.com/">RVM</a> (Ruby Version Manager) is one of the must-have tools in ruby world. It installs all ruby versions you want, manages gem sets and lots of more.</p>

        <p>At first you need to open your terminal and paste this: <code>bash < <(curl -s https://rvm.beginrescueend.com/install/rvm)</code></p>

        <p>I assume that you are using bash, so you can command <code>echo '[[ -s "$HOME/.rvm/scripts/rvm" ]] && . "$HOME/.rvm/scripts/rvm" # Load RVM function' >> ~/.bash_profile</code> and now you have rvm running on next terminal session. To verify this, close current terminal session and open new. After that command <code>rvm -v</code> and you will see rvm version information, if all went fine.</p>

        <p>When we have RVM, it is time to manage ruby versions. Lets install ruby 1.8.7: <code>rvm install 1.8.7</code> Now the latest patch ruby version 1.8.7 is compiling and installing. When this is done, you can use it with <code>rvm use 1.8.7</code>, but you don't want to command this every time you open new terminal, so lets make it default ruby with <code>rvm use 1.8.7 --default</code></p>

        <p>Lets verify that we have RVM installed ruby. <code>gem env</code> the command output should specify paths so that they point under the .rvm-directory in your home.</p>

        <h3>Installing bundler to manage your gems</h3>

        <p>In Windows just <code>gem install bundler</code> (pik doesn't have gem sets).</p>

        <p>In Unix you want to install bundler so that all your projects can access to it, so lets make it in global gemset. First make global gemset in use: <code>rvm gemset use global</code> (verify this with <code>gem env</code> so that all there should be only one line under GEM PATHS and is should end @global). Now install bundler with <code>gem install bundler</code> You can clear used gemset to default, but not necessary: <code>rvm gemset clear</code></p>

        <p>This should be the last time you use <code>gem install <name of gem></code> If not so, you should re-think, what you are doing.</p>


        <h2 id="creating_new_sinatra_project">Creating new project with sinatra</h2>

        <p>Before this, I have created new repository in github and followed instruction from there. My stage is that I have empty README-file with initial commit.</p>

        <h3>Setting up RVM for this project</h3>

        <p>At first I want to add .rvmrc file with my project gemset. webapp-tutorial/.rvmrc looks like this: <code>rvm use 1.8.7@webapp-tutorial</code> (In windows, make just this and skip following. By doing this, you are kind to Unix users)</p>

        <p>When I enter my webapp-tutorial directory, RVM asks me if I want to add currently found .rvmrc-file in trusted files and that's what I want to do (answer yes). Without any customizing, RVM should tell you to create used gemset, so lets create one: <code>rvm gemset create webapp-tutorial</code> Re-enter after this.</p>

        <p>If everything went fine, <code>gem env</code> should show you two lines in GEM PATHS, one ending webapp-tutorial and another one ending global.</p>

        <h3>Setting project bundler</h3>

        <p>Just command: <code>bundle init</code> Now you should have Gemfile called file in your working directory.</p>

        <p>You can always check if your gems are fine with <code>bundle check</code> It will tell what to do, if they aren't fine (mostly tells to install them). Now you should have Gemfile.lock, which contains information about your gems.</p>

        <p>You can install gems with bundler by commanding <code>bundle install</code></p>

        <h3>Lets install sinatra</h3>

        <p>Just add <code>gem 'sinatra'</code> in your Gemfile and run <code>bundle install</code></p>

        <h3>Create first sinatra application with hello world response</h3>

        <p>Create my_sinatra_app.rb which constains following code:</p>
        <pre>require 'rubygems'
require 'sinatra'

get '/' do
  "Hello world"
end</pre>

        <p>For easy server use, you should have config.ru:</p>
        <pre>require './my_sinatra_app'

run Sinatra::Application</pre>

        <p>Last think is to run your new born application: <code>rackup</code> and open your browser with url <a href="http://localhost:9292">http://localhost:9292</a> (9292 should be the default rack port, change it if rackup tells a different one)</p>


        <p class="gommit">Now is good time for a commit!</p>


        <h2 id="short_ruby_tutorial">Short ruby tutorial</h2>

        <h3>Naming your methods</h3>

        <p>In ruby you will face three kind of methods: <code>this_is_a_common_method()</code>, <code>do_i_ask_something?()</code> and <code>i_tell_you_to_do_this!()</code> First one is the same kind of method, you would use for example in Java. Second one asks something and only understads boolean answer, for example you want to know if use is admin, just call user.admin? and it will tell true or false. So if you have method, which returns boolean, add ? in the end of that method's name. The last one is a bang-method. It tries to do your request, but if something goes wrong, it will rage on you in the form of exception. Bang also affect its host. Here is an example about bang:</p>

        <pre><code>my_own_list = [1,4,3,6]
my_own_list.map{|x| x*2}    # => [2,8,6,12]
my_own_list                 # => [1,4,3,6]

my_own_list.map!{|x| x*2}   # => [2,8,6,12]
my_own_list                 # => [2,8,6,12]</code></pre>

        <h3>Ruby variables</h3>

        <p>Normal variables can be declared in anywhere: <code>my_array_variable = []</code> If you want instance variable, but @ before the name and class variable has @@ before the name.</p>


        <h2 id="handling_responses">Handling responses</h2>

        <h3>HTTP request methods</h3>

        <p>You can use every <a href="http://en.wikipedia.org/wiki/Http#Request_methods">HTTP request method</a> with sinatra.</p>

        <pre><code>get '/' do
  'Used HTTP GET-method'
end

post '/' do
  'Used HTTP POST-method'
end

put '/' do
  'Used HTTP PUT-method'
end

delete '/' do
  'Used HTTP DELETE-method'
end

options '/' do
  'Used HTTP OPTIONS-method'
end</code></pre>

        <p>For example if you go http://my_application/foo/bar the request most likely will be handled in <code>get '/foo/bar'</code></p>

        <h3>Named parameters</h3>

        <p>You can pass named parameters in url without using GET paramater-format <code>?paramater1=value1&amp;parameter2=value2</code> ... In sinatra you can pass them in clean url format <code>/paramater1/value1/parameter2/value2</code> and it is quite easy to do:</p>

        <pre><code>get '/paramater1/:value1/parameter2/:value2' do
  "Parameters are #{params[:value1]} and #{params[:value2]}"
end</code></pre>

        <h2 id="creating_erbviews">Creating erb-views</h2>

        <p>It would be stupid to return everything in strings or print the text with <code>puts</code> so there are lots of template languages, which you can use. I'm going to tell about erb, because it is html embedded with ruby. All you have to do is <code>require 'erb'</code> and call <code>erb</code>-method with name of view, you want to render.</p>

        <p><strong>example_application.rb</strong></p>
        <pre><code>require 'rubygems'
require 'sinatra'
require 'erb'

get '/' do
  erb :index
end</code></pre>

        <p><strong>views/index.erb</strong></p>
        <pre><code>&lt;p&gt;Hello world&lt;/p&gt;
&lt;% 5.times do %&gt;
  &lt;%= 'this is handled as ruby' %&gt;
&lt;% end %&gt;</code></pre>

        <p>By default erb uses layout-file so you don't have to write common parts for every file: <strong>views/layout.erb</strong></p>
        <pre><code>&lt;html&gt;
  &lt;head&gt;
      &lt;title&gt;My example application&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;My page content:&lt;/h1&gt;
    &lt;%= yield %&gt;
  &lt;/body&gt;
&lt;/html&gt;</code></pre>

        <p>As you can see the ruby come is inside <code>&lt;% %&gt;</code> and if you want to print the output, just add =-mark after the <code>&lt;%</code>.

        <h2 id="using_classes">Using classes</h2>

        <p>More common way to use sinatra is oop-way where you make subclass from Sinatra::Base class.</p>

        <pre><code>require 'rubygems'
require 'sinatra'

class Tsoha < Sinatra::Base
  get '/' do
    'index'
  end

  get '/about' do
    'about'
  end
end </code></pre>

        <h2 id="adding_database">Adding database</h2>

        <p>Just assume that we have SQLite database in our development machine. I introduce database usage through DataMapper, which is nice and quite simple gem for this.</p>

        <p>Just add <code>gem 'data_mapper'</code> and <code>gem 'dm-sqlite-adapter'</code> in your Gemfile. In debian-based system like ubuntu, you need to install sqlite3-dev libraries: <code>sudo apt-get install libsqlite3-dev</code> And now we can start the actual database hacking!</p>

        <p><strong>models.rb</strong></p>
        <pre><code>require 'rubygems'
require 'data_mapper'

# Define that our database is in memory, use file in permanent solution :P
DataMapper.setup(:default, 'sqlite::memory:')

# Lets create users-table in our database
class User
  include DataMapper::Resource

  # user has username, which is also primary key
  property :username, String, :key => true

  # user has password
  property :password, String

  # user has name
  property :name, String

  # user has many messages
  has n, :messages
end

# Lets create messages-table in our database
class Message
  include DataMapper::Resource

  # message has id
  property :id, Serial # Serial is auto increment integer and also id is the default key

  # message has body
  property :body, Text

  # message belongs to its author
  belongs_to :user
end

# Now we have to finalize the data
DataMapper.finalize

# And at last we have to make changes to database (this first drops the tables and then creates create tables according models)
DataMapper.auto_migrate!</code></pre>

        <h2 id="sessions">Sessions</h2>

        <h2 id="heroku_deployment">Heroku deployment</h2>


        <h2 id="read_more">Read more</h2>

        <ul>
            <li><a href="http://sinatra-book.gittr.com/">Sinatra book</a></li>
            <li><a href="http://sinatra-book-contrib.com/">Sinatra book (extra parts)</a></li>
            <li><a href="http://apidock.com/">APIdock</a></li>
            <li><a href="http://datamapper.org/">DataMapper</a></li>
        </ul>


        <hr />
        <p>Author: Sami Saada (CC0) 2011</p>

    </body>
</html>
